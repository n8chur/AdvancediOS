version: 2
jobs:
  build:

    macos:
      xcode: "10.1.0"
    
    # This should set the approprate ruby version from the .ruby-version file
    shell: /bin/bash --login -eo pipefail

    environment:
      ENV: CI

    steps:
      - checkout

      - restore_cache:
          keys:
            - rome
            - v1-gems-{{ checksum "Gemfile.lock" }}
            - v1-gems-

      - run:
          name: Setup Project
          command: brew bundle && bundle install
          environment:
            BUNDLE_PATH: vendor/bundle

      - run:
          name: Bootstrap Project
          command: bundle exec fastlane bootstrap
          environment:
            BUNDLE_PATH: vendor/bundle

      - run:
          name: Verify SwiftGen Causes No Changes
          command: bundle exec fastlane verify_swiftgen
          environment:
            BUNDLE_PATH: vendor/bundle

      - run:
          name: Lint project
          command: bundle exec fastlane lint
          environment:
            BUNDLE_PATH: vendor/bundle

      - run:
          name: Build and run tests
          command: bundle exec fastlane test
          environment:
            BUNDLE_PATH: vendor/bundle

      - save_cache:
          key: rome
          paths:
            - RomeCache

      - save_cache:
          key: v1-gems-{{ checksum "Gemfile.lock" }}
          paths:
            - vendor/bundle

      - store_test_results:
          path: fastlane/test_output
      - store_artifacts:
          path: fastlane
          destination: scan-test-results
      - store_artifacts:
          path: ~/Library/Logs/scan
          destination: scan-logs
