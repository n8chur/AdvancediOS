version: 2
jobs:
  build:

    macos:
      xcode: "10.1.0"
    
    # This should set the approprate ruby version from the .ruby-version file
    shell: /bin/bash --login -eo pipefail

    environment:
      MINT_LINK_PATH: ~/MintCache/bin

    steps:
      - checkout

      - restore_cache:
          keys:
            - v1-rome-

      - restore_cache:
          keys:
            - v2-gems-{{ checksum "Gemfile.lock" }}
            - v2-gems-

      - restore_cache:
          keys:
            - v2-mint-
              
      - restore_cache:
          keys:
            - v2-brew-

      - run:
          name: Setup Project
          command: |
            brew bundle
            bundle install --retry=3 --path .bundle
            mint install yonaskolb/XcodeGen@2.0.0 # XXX: REMOVE
            mint install SwiftGen/SwiftGen@6.0.2 # XXX: REMOVE
            bundle exec fastlane carthage_bootstrap # XXX: REMOVE 

      # - run:
      #     name: Bootstrap Project
      #     command: bundle exec fastlane bootstrap

      # - run:
      #     name: Verify SwiftGen Causes No Changes
      #     command: bundle exec fastlane verify_swiftgen

      # - run:
      #     name: Lint project
      #     command: bundle exec fastlane lint

      # - run:
      #     name: Build and run tests
      #     command: bundle exec fastlane test

      - save_cache:
          key: v1-rome-
          paths:
            - RomeCache

      - save_cache:
          key: v2-gems-{{ checksum "Gemfile.lock" }}
          paths:
            - .bundle

      - save_cache:
          key: v2-mint-
          paths:
            - ~/MintCache

      - save_cache:
          key: v2-brew-
          paths:
            - /usr/local/Cellar

      - store_test_results:
          path: fastlane/test_output
      - store_artifacts:
          path: fastlane
          destination: scan-test-results
      - store_artifacts:
          path: ~/Library/Logs/scan
          destination: scan-logs
